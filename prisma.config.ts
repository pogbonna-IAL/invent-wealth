// This file was generated by Prisma, and assumes you have installed the following:
// npm install --save-dev prisma dotenv
// Load dotenv/config for local development (Railway doesn't use .env files)
// dotenv/config only sets variables that don't already exist, so Railway's env vars take precedence
import "dotenv/config";
import { defineConfig } from "prisma/config";

// Get DATABASE_URL from environment
// Railway injects this when services are linked
// Read it directly - it should be available when Prisma CLI runs
// Use a getter function that reads fresh each time
let _databaseUrl: string | undefined = undefined;

function getDatabaseUrl(): string {
  // Always read fresh from process.env
  const url = process.env.DATABASE_URL;
  if (url !== _databaseUrl) {
    _databaseUrl = url;
    if (url) {
      console.log("DATABASE_URL found in config:", url.substring(0, 30) + "...");
    } else {
      console.warn("Warning: DATABASE_URL not found in environment.");
      console.warn("Available env vars with 'DATABASE' or 'DB':", 
        Object.keys(process.env).filter(k => k.includes("DATABASE") || k.includes("DB")).join(", ") || "none");
    }
  }
  return url || "";
}

export default defineConfig({
  schema: "prisma/schema.prisma",
  migrations: {
    path: "prisma/migrations",
  },
  datasource: {
    // Read DATABASE_URL fresh - Prisma 7.x will validate it
    get url() {
      return getDatabaseUrl();
    },
  },
});
